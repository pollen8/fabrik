var ListFieldsElement=new Class({Implements:[Options,Events],addWatched:false,options:{conn:null,highlightpk:false,showAll:1,mode:"dropdown",defaultOpts:[],addBrackets:false},initialize:function(c,b){this.strEl=c;var a;this.el=c;this.setOptions(b);if(this.options.defaultOpts.length>0){this.el=document.id(this.el);if(this.options.mode==="gui"){this.select=this.el.getParent().getElement("select.elements");els=[this.select];if(typeOf(document.id(this.options.conn))==="null"){this.watchAdd()}}else{els=document.getElementsByName(this.el.name);this.el.empty();document.id(this.strEl).empty()}var d=this.options.defaultOpts;Array.each(els,function(e){document.id(e).empty()});d.each(function(e){var f={value:e.value};if(e.value===this.options.value){f.selected="selected"}Array.each(els,function(g){a=e.label?e.label:e.text;new Element("option",f).set("text",a).inject(g)})}.bind(this))}else{if(typeOf(document.id(this.options.conn))==="null"){this.cnnperiodical=this.getCnn.periodical(500,this)}else{this.setUp()}}},cloned:function(b,a){this.strEl=b;this.el=document.id(b);this._cloneProp("conn",a);this._cloneProp("table",a);this.setUp()},_cloneProp:function(c,a){var b=this.options[c].split("-");b=b.splice(0,b.length-1);b.push(a);this.options[c]=b.join("-")},getCnn:function(){if(typeOf(document.id(this.options.conn))==="null"){return}this.setUp();clearInterval(this.cnnperiodical)},setUp:function(){this.el=document.id(this.el);if(this.options.mode==="gui"){this.select=this.el.getParent().getElement("select.elements")}document.id(this.options.conn).addEvent("change",function(){this.updateMe()}.bind(this));document.id(this.options.table).addEvent("change",function(){this.updateMe()}.bind(this));var a=document.id(this.options.conn).get("value");if(a!==""&&a!==-1){this.periodical=this.updateMe.periodical(500,this)}this.watchAdd()},watchAdd:function(){if(this.addWatched===true){return}this.addWatched=true;var a=this.el.getParent().getElement("button");if(typeOf(a)!=="null"){a.addEvent("mousedown",function(b){b.stop();this.addPlaceHolder()}.bind(this));a.addEvent("click",function(b){b.stop()})}},updateMe:function(e){if(typeOf(e)==="event"){e.stop()}if(document.id(this.el.id+"_loader")){document.id(this.el.id+"_loader").show()}var cid=document.id(this.options.conn).get("value");var tid=document.id(this.options.table).get("value");if(!tid){return}clearInterval(this.periodical);var url="index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=element&plugin=field&method=ajax_fields&showall="+this.options.showAll+"&cid="+cid+"&t="+tid;var myAjax=new Request({url:url,method:"get",data:{highlightpk:this.options.highlightpk,k:2},onComplete:function(r){var els;if(typeOf(document.id(this.strEl))!==null){this.el=document.id(this.strEl)}if(this.options.mode==="gui"){els=[this.select]}else{els=document.getElementsByName(this.el.name);this.el.empty();document.id(this.strEl).empty()}var opts=eval(r);Array.each(els,function(el){document.id(el).empty()});opts.each(function(opt){var o={value:opt.value};if(opt.value===this.options.value){o.selected="selected"}Array.each(els,function(el){new Element("option",o).set("text",opt.label).inject(el)})}.bind(this));if(document.id(this.el.id+"_loader")){document.id(this.el.id+"_loader").hide()}}.bind(this)});Fabrik.requestQueue.add(myAjax)},addPlaceHolder:function(){console.log("addPlaceHolder");var b=this.el.getParent().getElement("select");var a=b.get("value");if(this.options.addBrackets){a=a.replace(/\./,"___");a="{"+a+"}"}this.insertTextAtCaret(this.el,a)},getInputSelection:function(e){var h=0,c=0,g,d,b,a,f;if(typeof e.selectionStart==="number"&&typeof e.selectionEnd==="number"){h=e.selectionStart;c=e.selectionEnd}else{d=document.selection.createRange();if(d&&d.parentElement()===e){a=e.value.length;g=e.value.replace(/\r\n/g,"\n");b=e.createTextRange();b.moveToBookmark(d.getBookmark());f=e.createTextRange();f.collapse(false);if(b.compareEndPoints("StartToEnd",f)>-1){h=c=a}else{h=-b.moveStart("character",-a);h+=g.slice(0,h).split("\n").length-1;if(b.compareEndPoints("EndToEnd",f)>-1){c=a}else{c=-b.moveEnd("character",-a);c+=g.slice(0,c).split("\n").length-1}}}}return{start:h,end:c}},offsetToRangeCharacterMove:function(a,b){return b-(a.value.slice(0,b).split("\r\n").length-1)},setSelection:function(d,e,b){if(typeof d.selectionStart==="number"&&typeof d.selectionEnd==="number"){d.selectionStart=e;d.selectionEnd=b}else{if(typeof d.createTextRange!=="undefined"){var c=d.createTextRange();var a=this.offsetToRangeCharacterMove(d,e);c.collapse(true);if(e===b){c.move("character",a)}else{c.moveEnd("character",this.offsetToRangeCharacterMove(d,b));c.moveStart("character",a)}c.select()}}},insertTextAtCaret:function(b,d){var e=this.getInputSelection(b).end;var a=e+d.length;var c=b.value;b.value=c.slice(0,e)+d+c.slice(e);this.setSelection(b,a,a)}});