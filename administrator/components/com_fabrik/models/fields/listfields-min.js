/*! Fabrik */

var ListFieldsElement=new Class({Implements:[Options,Events],addWatched:!1,options:{conn:null,highlightpk:!1,showAll:1,mode:"dropdown",defaultOpts:[],addBrackets:!1},initialize:function(e,t){var i,o;if(this.strEl=e,this.el=e,this.setOptions(t),0<this.options.defaultOpts.length){this.el=document.id(this.el),"gui"===this.options.mode?(this.select=this.el.getParent().getElement("select.elements"),o=[this.select],"null"===typeOf(document.id(this.options.conn))&&this.watchAdd()):(o=document.getElementsByName(this.el.name),this.el.empty(),document.id(this.strEl).empty());var n=this.options.defaultOpts;Array.each(o,function(e){document.id(e).empty()}),n.each(function(t){var n={value:t.value};t.value===this.options.value&&(n.selected="selected"),Array.each(o,function(e){i=t.label?t.label:t.text,new Element("option",n).set("text",i).inject(e)})}.bind(this))}else"null"===typeOf(document.id(this.options.conn))?this.cnnperiodical=this.getCnn.periodical(500,this):this.setUp()},cloned:function(e,t){this.strEl=e,this.el=document.id(e),this._cloneProp("conn",t),this._cloneProp("table",t),this.setUp()},_cloneProp:function(e,t){var n=this.options[e].split("-");(n=n.splice(0,n.length-1)).push(t),this.options[e]=n.join("-")},getCnn:function(){"null"!==typeOf(document.id(this.options.conn))&&(this.setUp(),clearInterval(this.cnnperiodical))},setUp:function(){this.el=document.id(this.el),"gui"===this.options.mode&&(this.select=this.el.getParent().getElement("select.elements")),document.id(this.options.conn).addEvent("change",function(){this.updateMe()}.bind(this)),document.id(this.options.table).addEvent("change",function(){this.updateMe()}.bind(this));var e=document.id(this.options.conn).get("value");""!==e&&-1!==e&&(this.periodical=this.updateMe.periodical(500,this)),this.watchAdd()},watchAdd:function(){if(!0!==this.addWatched){console.log("watch add",this),this.addWatched=!0;var e=this.el.getParent().getElement("button");"null"!==typeOf(e)&&(e.addEvent("mousedown",function(e){e.stop(),this.addPlaceHolder()}.bind(this)),e.addEvent("click",function(e){e.stop()}))}},updateMe:function(e){"event"===typeOf(e)&&e.stop(),document.id(this.el.id+"_loader")&&document.id(this.el.id+"_loader").show();var conn=document.id(this.options.conn);if(conn){var cid=document.id(this.options.conn).get("value"),tid=document.id(this.options.table).get("value");if(tid){clearInterval(this.periodical);var url="index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=element&plugin=field&method=ajax_fields&showall="+this.options.showAll+"&cid="+cid+"&t="+tid,myAjax=new Request({url:url,method:"get",data:{highlightpk:this.options.highlightpk,k:2},onComplete:function(r){var els;null!==typeOf(document.id(this.strEl))&&(this.el=document.id(this.strEl)),"gui"===this.options.mode?els=[this.select]:(els=document.getElementsByName(this.el.name),this.el.empty(),document.id(this.strEl).empty());var opts=eval(r);Array.each(els,function(e){document.id(e).empty()}),opts.each(function(t){var n={value:t.value};t.value===this.options.value&&(n.selected="selected"),Array.each(els,function(e){new Element("option",n).set("text",t.label).inject(e)})}.bind(this)),document.id(this.el.id+"_loader")&&document.id(this.el.id+"_loader").hide()}.bind(this)});Fabrik.requestQueue.add(myAjax)}}else clearInterval(this.periodical)},addPlaceHolder:function(){var e=this.el.getParent().getElement("select").get("value");this.options.addBrackets&&(e="{"+(e=e.replace(/\./,"___"))+"}"),this.insertTextAtCaret(this.el,e)},getInputSelection:function(e){var t,n,i,o,s,l=0,a=0;return"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd?(l=e.selectionStart,a=e.selectionEnd):(n=document.selection.createRange())&&n.parentElement()===e&&(o=e.value.length,t=e.value.replace(/\r\n/g,"\n"),(i=e.createTextRange()).moveToBookmark(n.getBookmark()),(s=e.createTextRange()).collapse(!1),-1<i.compareEndPoints("StartToEnd",s)?l=a=o:(l=-i.moveStart("character",-o),l+=t.slice(0,l).split("\n").length-1,-1<i.compareEndPoints("EndToEnd",s)?a=o:(a=-i.moveEnd("character",-o),a+=t.slice(0,a).split("\n").length-1))),{start:l,end:a}},offsetToRangeCharacterMove:function(e,t){return t-(e.value.slice(0,t).split("\r\n").length-1)},setSelection:function(e,t,n){if("number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd)e.selectionStart=t,e.selectionEnd=n;else if(void 0!==e.createTextRange){var i=e.createTextRange(),o=this.offsetToRangeCharacterMove(e,t);i.collapse(!0),t===n?i.move("character",o):(i.moveEnd("character",this.offsetToRangeCharacterMove(e,n)),i.moveStart("character",o)),i.select()}},insertTextAtCaret:function(e,t){var n=this.getInputSelection(e).end,i=n+t.length,o=e.value;e.value=o.slice(0,n)+t+o.slice(n),this.setSelection(e,i,i)}});