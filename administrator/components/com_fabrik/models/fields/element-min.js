/*! Fabrik */

var elementElement=new Class({Implements:[Options,Events],options:{plugin:"chart",excludejoined:0,value:"",highlightpk:0},initialize:function(e,t){this.el=e,this.setOptions(t),this.ready()?this.setUp():this.cnnperiodical=this.getCnn.periodical(500,this)},ready:function(){return"null"!==typeOf(document.id(this.options.conn))&&("undefined"!==typeOf(FabrikAdmin.model.fields.fabriktable)&&(0!==Object.getLength(FabrikAdmin.model.fields.fabriktable)&&-1!==Object.keys(FabrikAdmin.model.fields.fabriktable).indexOf(this.options.table)))},getCnn:function(){this.ready()&&(this.setUp(),clearInterval(this.cnnperiodical))},setUp:function(){var e=this.el;this.el=document.id(this.el),"null"===typeOf(this.el)&&fconsole("element didnt find me, ",e);var t=this.el.getParent().getElement("button");"null"!==typeOf(t)&&(t.addEvent("mousedown",function(e){e.stop(),this.addPlaceHolder()}.bind(this)),t.addEvent("click",function(e){e.stop()})),FabrikAdmin.model.fields.fabriktable[this.options.table].registerElement(this)},addPlaceHolder:function(){var e=this.el.getParent().getElement("select");this.insertTextAtCaret(this.el,"{"+e.get("value")+"}")},getOpts:function(){return $H({calcs:this.options.include_calculations,showintable:this.options.showintable,published:this.options.published,excludejoined:this.options.excludejoined,highlightpk:this.options.highlightpk})},cloned:function(e,t){this.el=e;var n=this.options.table.split("-");n.pop(),this.options.table=n.join("-")+"-"+t,this.setUp()},getSelectionBoundary:function(e,t){var n,i,o,s,l,a=t?"selectionStart":"selectionEnd";if("number"==typeof e[a])return e[a];if(document.selection&&document.selection.createRange){e.focus();var c=document.selection.createRange();if(c)return"Text"===document.selection.type&&c.collapse(!!t),n=e.value,i=e.createTextRange(),o=e.createTextRange(),s=0,l=c.getBookmark(),i.moveToBookmark(l),-1<n.indexOf("\r\n")?(i.text=" ",o.setEndPoint("EndToStart",i),s=o.text.length-1,document.execCommand("undo")):(o.setEndPoint("EndToStart",i),s=o.text.length),s}return 0},offsetToRangeCharacterMove:function(e,t){return t-(e.value.slice(0,t).split("\r\n").length-1)},setSelection:function(e,t,n){var i=e.createTextRange(),o=this.offsetToRangeCharacterMove(e,t);i.collapse(!0),t===n?i.move("character",o):(i.moveEnd("character",this.offsetToRangeCharacterMove(e,n)),i.moveStart("character",o)),i.select()},insertTextAtCaret:function(e,t){var n=this.getSelectionBoundary(e,!1),i=n+t.length,o=e.value;e.value=o.slice(0,n)+t+o.slice(n),this.setSelection(e,i,i)}});