/*! Fabrik */

define(["jquery","fab/fabrik"],function(r,a){"use strict";return new Class({Implements:[Events],options:{observe:"",trigger:"",cnn:0,table:0,map:"",editOrig:!1,fillOnLoad:!1,confirm:!0,autofill_lookup_field:0,showNotFound:!1,notFoundMsg:""},initialize:function(t){var o=this;this.options=r.extend(this.options,t),this.attached=[],this.newAttach=[],this.setupDone=!1,this.setUp(a.getBlock("form_"+this.options.formid)),a.addEvent("fabrik.form.elements.added",function(t){o.setUp(t)}),a.addEvent("fabrik.form.element.added",function(t,e,n){o.element&&(n.strElement,o.element.strElement)})},getElement:function(e){var n=!1,o=this,i=this.form.formElements.get(this.options.observe),s=0;return i?this.attached.push(i.options.element):Object.keys(this.form.formElements).each(function(t){t.contains(o.options.observe)&&(n=o.form.formElements.get(t),o.attached.contains(n.options.element)||o.attached.push(n.options.element),"null"!==typeOf(e)&&e!==s||(i=n),s++)}),i},setUp:function(t){var n=this;if(!this.setupDone&&void 0!==t){try{this.form=t}catch(t){return}var e=function(t){n.lookUp(t)},o=!1,i=this.form.formElements.get(this.options.observe);if(i)this.attached.push(i.options.element),n.newAttach.push(i.options.element);else{var s=0;Object.keys(this.form.formElements).each(function(t){if(t.contains(n.options.observe)){o=n.form.formElements.get(t),n.attached.contains(o.options.element)||(n.attached.push(o.options.element),n.newAttach.push(o.options.element));var e=parseInt(o.getRepeatNum(),10);(isNaN(e)||e===s)&&(i=o),s++}})}if(this.element=i,""===this.options.trigger)if(this.element){var r=this.element.getBlurEvent();this.newAttach.each(function(t){n.form.formElements.get(t);n.form.dispatchEvent("",t,r,e),n.options.fillOnLoad&&n.form.dispatchEvent("",t,"load",e)})}else fconsole("autofill - couldnt find element to observe");else this.form.dispatchEvent("",this.options.trigger,"click",e),this.options.fillOnLoad&&this.form.dispatchEvent("",this.options.trigger,"load",e);this.setupDone=!0,this.newAttach=[]}},lookUp:function(t){if(this.options.trigger||(this.element=t),!0!==this.options.confirm||window.confirm(Joomla.JText._("PLG_FORM_AUTOFILL_DO_UPDATE"))){a.loader.start("form_"+this.options.formid,Joomla.JText._("PLG_FORM_AUTOFILL_SEARCHING")),this.element||(this.element=this.getElement(0));var e=this.element.getValue(),n=this.options.formid,o=this.options.observe,i=this;r.ajax({url:"index.php",method:"post",dataType:"json",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"autofill",method:"ajax_getAutoFill",g:"form",v:e,formid:n,observe:o,cnn:this.options.cnn,table:this.options.table,map:this.options.map,autofill_lookup_field:this.options.autofill_lookup_field}}).always(function(){a.loader.stop("form_"+i.options.formid)}).fail(function(t,e,n){window.alert(e)}).done(function(t){i.updateForm(t)})}},updateForm:function(t){this.json=t,a.fireEvent("fabrik.form.autofill.update.start",[this,t]);var e,n,o,i=this.element.getRepeatNum();if(r.isEmptyObject(this.json)){if(this.options.showNotFound){var s=""===this.options.notFoundMsg?Joomla.JText._("PLG_FORM_AUTOFILL_NORECORDS_FOUND"):this.options.notFoundMsg;window.alert(s)}}else{for(e in this.json)this.json.hasOwnProperty(e)&&(n=this.json[e],"_raw"===e.substr(e.length-4,4)&&(o=e=e.replace("_raw",""),this.tryUpdate(e,n)||(e=this.updateRepeats(e,n,i,o))));!0===this.options.editOrig&&(this.form.getForm().getElement("input[name=rowid]").value=this.json.__pk_val),a.fireEvent("fabrik.form.autofill.update.end",[this,t])}},updateRepeats:function(t,e,n,o){var i,s;if("object"==typeof e)for(i in e)e.hasOwnProperty(i)&&(s=t+"_"+i,this.tryUpdate(s,e[i]));else t+=n?"_"+n:"_0",this.tryUpdate(t,e)||(t="join___"+this.element.options.joinid+"___"+t,this.tryUpdate(o,e,!0));return t},tryUpdate:function(n,e,t){var o,i,s=this;if(t=!!t){if(0<(o=Object.keys(this.form.formElements).filter(function(t,e){return t.contains(n)})).length)return o.each(function(t){(i=s.form.elements[t]).update(e),i.baseElementId!==s.element.baseElementId&&(i.element.fireEvent(i.getBlurEvent(),new Event.Mock(i.element,i.getBlurEvent())),i.getBlurEvent()!==i.getChangeEvent()&&i.element.fireEvent(i.getChangeEvent(),new Event.Mock(i.element,i.getChangeEvent())))}),!0}else if(void 0!==(i=this.form.elements[n]))return"auto-complete"===i.options.displayType&&(i.activePopUp=!0),i.update(e),i.baseElementId!==this.element.baseElementId&&(i.element.fireEvent(i.getBlurEvent(),new Event.Mock(i.element,i.getBlurEvent())),i.getBlurEvent()!==i.getChangeEvent()&&i.element.fireEvent(i.getChangeEvent(),new Event.Mock(i.element,i.getChangeEvent()))),!0;return!1}})});