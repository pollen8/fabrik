/*! Fabrik */

define(["jquery","fab/fabrik","fullcalendar"],function(p,w,t){return new Class({Implements:[Options],options:{canAdd:!1,show_week:!1,show_day:!1,default_view:"dayView",time_format:"",first_week_day:1,minDuration:0,greyscaledweekend:!1,calOptions:{},startOffset:0,url:{del:"index.php?option=com_fabrik&controller=visualization.fullcalendar&view=visualization&task=deleteEvent&format=raw"}},initialize:function(t,e){var a=this,i="",n=[];this.el=p("#"+t),this.calendar=this.el.find('*[data-role="calendar"]'),this.setOptions(e),this.date=new Date,this.clickdate=null,this.ajax={},this.windowopts={id:"addeventwin",title:"",loadMethod:"xhr",minimizable:!1,evalScripts:!0},this.el.find(".addEventButton").on("click",function(t){t.preventDefault(),a.openAddEvent(t)}),w.addEvent("fabrik.form.submitted",function(t,e){a.calendar.fullCalendar("refetchEvents"),w.Windows.addeventwin.close()}),this.options.eventLists.each(function(o,d){n.push({events:function(t,e,i,n){var a=this.options.url.add;a.test(/\?/)?a+="&":a+="?",a+="listid="+o.value,a+="&eventListKey="+d,a+="&startDate="+t.format(),a+="&endDate="+e.format(),new Request({url:a,data:this.options.urlfilters,evalScripts:!0,onSuccess:function(t,e){"null"!==typeOf(e)&&this.processEvents(e,n)}.bind(this,n)}).send()}.bind(this),color:o.colour})}.bind(this)),!1!==this.options.show_week&&(i+="agendaWeek"),!1!==this.options.show_day&&(0<i.length&&(i+=","),i+="agendaDay"),0<i.length&&(i="month,"+i);var o="month";switch(this.options.default_view){case"monthView":break;case"weekView":!1!==this.options.show_week&&(o="agendaWeek");break;case"dayView":!1!==this.options.show_day&&(o="agendaDay")}var d=null,s=null;function l(){d=s=null,a.calendar.off("mousemove",l)}this.calendar.dblclick(function(t){d&&a.openAddEvent(t,s,d)}),this.calOptions={header:{left:"prev,next today",center:"title",right:i},fixedWeekCount:!1,timeFormat:this.options.time_format,defaultView:o,nextDayThreshold:"00:00:00",firstDay:this.options.first_week_day,eventSources:n,defaultTimedEventDuration:this.options.minDuration,minTime:this.options.open,maxTime:this.options.close,weekends:this.options.showweekends,eventClick:function(t,e,i){return e.stopPropagation(),e.preventDefault(),a.clickEntry(t),!1},dayClick:function(t,e,i){"touchend"===e.type?a.openAddEvent(e,i.name,t):(d=t,s=i.name,a.calendar.on("mousemove",l))},viewRender:function(t,e){!0===a.options.greyscaledweekend&&(p("td.fc-sat").css("background","#f2f2f2"),p("td.fc-sun").css("background","#f2f2f2"))},eventRender:function(t,e){e.find(".fc-title").html(t.title)},loading:function(t){}},p.extend(!0,this.calOptions,JSON.parse(a.options.calOptions)),this.calendar.fullCalendar(this.calOptions),p(document).on("click","button[data-task=viewCalEvent], a[data-task=viewCalEvent]",function(t){t.preventDefault();var e=p(t.target).closest(".calEventButtonsID");if(0===e.length&&(e=p(t.target).closest(".modal-body").next().find(".calEventButtonsID")),0!==e.length){var i=e[0].id;i=i.replace(/_buttons/,"");var n=a.calendar.fullCalendar("clientEvents",i)[0];p("#fabrikEvent_modal").modal("hide"),a.viewEntry(n)}}),p(document).on("click","button[data-task=editCalEvent], a[data-task=editCalEvent]",function(t){t.preventDefault();var e=p(t.target).closest(".calEventButtonsID");if(0===e.length&&(e=p(t.target).closest(".modal-body").next().find(".calEventButtonsID")),0!==e.length){var i=e[0].id;i=i.replace(/_buttons/,"");var n=a.calendar.fullCalendar("clientEvents",i)[0];p("#fabrikEvent_modal").modal("hide"),a.editEntry(n)}}),p(document).on("click","button[data-task=deleteCalEvent], a[data-task=deleteCalEvent]",function(t){t.preventDefault();var e=p(t.target).closest(".calEventButtonsID");if(0===e.length&&(e=p(t.target).closest(".modal-body").next().find(".calEventButtonsID")),0!==e.length){var i=e[0].id;i=i.replace(/_buttons/,"");var n=a.calendar.fullCalendar("clientEvents",i)[0];p("#fabrikEvent_modal").modal("hide"),a.deleteEntry(n)}});var r=this.options.url.del;function c(){var t=p(this);t.css("display","block"),t.css("margin-top",Math.max(0,(p(window).height()-t.height())/2));var e="-"+t.width()/2+"px!important";t.css("margin-left",e)}r.test(/\?/)?r+="&":r+="?",r+="task=deleteEvent",this.ajax.deleteEvent=new Request({url:r,data:{visualizationid:this.options.calendarId},onComplete:function(){a.calendar.fullCalendar("refetchEvents")}}),p(".modal").on("show.bs.modal",c),p(window).on("resize",function(){p(".modal:visible").each(c)})},processEvents:function(t,e){t=$H(JSON.parse(t));var i,n,a,o,d,s,l,r,c,h,u,f,m,v=[];t.each(function(t){c=p(w.jLayouts["fabrik-visualization-fullcalendar-event-popup"])[0],h=t._listid+"_"+t.id,c.id="fabrikevent_"+h,u=p(w.jLayouts["fabrik-visualization-fullcalendar-viewevent"])[0],f=moment(t.startdate),m=moment(t.enddate),l=r="",(moment(m.format("YYYY-MM-DD"))>moment(f.format("YYYY-MM-DD"))||!1===t.startShowTime&&!1===t.endShowTime)&&(l=f.format("MMM DD")+" ",r=m.format("MMM DD")+" "),i=n="",!0===t.startShowTime&&!0===t.endShowTime&&(i=f.format("hh.mm A"),n=m.format("hh.mm A")),u.getElement("#viewstart").innerHTML=l+i,u.getElement("#viewend").innerHTML=r+n;var e=p(u).find("[data-role=fabrik-popup-template]");e&&(""!==t.popupTemplate?p(e).prepend(t.popupTemplate):p(e).hide()),p(c).attr("data-content",p(u).prop("outerHTML")),(a=p(w.jLayouts["fabrik-visualization-fullcalendar-viewbuttons"]))[0].id="fabrikevent_buttons_"+h,o=a.find(".popupDelete"),!1===t._canDelete?o.remove():o.attr("title",Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DELETE")),d=a.find(".popupEdit"),!1===t._canEdit?d.remove():d.attr("title",Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_EDIT")),s=a.find(".popupView"),!1===t._canView?s.remove():s.attr("title",Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_VIEW")),p(c).attr("data-buttons",a.prop("outerHTML")),p(c).attr("data-title",t.label),p(c).append(t.label),v.push({id:c.id,title:p(c).prop("outerHTML"),start:t.startdate,end:t.enddate,url:t.link,viewURL:t.details,editURL:t.link,customURL:t.customLink,className:t.status,allDay:t.allday,listid:t._listid,rowid:t.__pk_val,formid:t._formid})}.bind(v)),e(v)},addEvForm:function(t){void 0!==p&&p(this.popOver).popover("hide"),this.windowopts.id="addeventwin";var e=this.options.url.addev;if(e.test(/\?/)?e+="&":e+="?",e+="listid="+t.listid,e+="&rowid="+t.rowid,e+="&fabrik_window_id="+this.windowopts.id,e+="&task=addEvForm",e+="&Itemid="+this.options.Itemid,e+="&editLink="+encodeURI(t.editURL),e+="&viewLink-"+encodeURI(t.viewURL),t.nextView&&(e+="&nextview="+t.nextView),null!==this.clickdate){this.clickdate=moment(this.clickdate).add({h:this.options.startOffset}).format("YYYY-MM-DD HH:mm:ss");var i=this.calendar.fullCalendar("option","defaultTimedEventDuration").split(":"),n=moment(this.clickdate).add({h:i[0],m:i[1],s:i[2]}).format("YYYY-MM-DD HH:mm:ss");e+="&start_date="+this.clickdate+"&end_date="+n}this.windowopts.type="window",this.windowopts.contentURL=e,this.windowopts.title=t.title,this.windowopts.modalId="fullcalendar_addeventwin";var a=this.options.filters;this.windowopts.onContentLoaded=function(){a.each(function(t){if(document.id(t.key))switch(document.id(t.key).get("tag")){case"select":document.id(t.key).selectedIndex=t.val;break;case"input":document.id(t.key).value=t.val}}),this.fitToContent(!1)},w.getWindow(this.windowopts)},viewEntry:function(t){this.clickdate=null;var e={};e.id=t.formid,e.rowid=t.rowid,e.listid=t.listid,e.nextView="details",e.title=Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_VIEW_EVENT"),this.addEvForm(e)},editEntry:function(t){this.clickdate=null;var e={};e.id=t.formid,e.rowid=t.rowid,e.listid=t.listid,e.nextView="form",e.title=Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_EDIT_EVENT"),this.addEvForm(e)},deleteEntry:function(t){if(window.confirm(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_CONF_DELETE"))){this.ajax.deleteEvent.options.data={id:t.rowid,listid:t.listid};var e=w.fireEvent("fabrik.viz.fullcalendar.deleteentry",[this,t]).eventResults;for(i=0;i<e.length;i++)typeOf("object"===e[i])&&p.extend(this.ajax.deleteEvent.options.data,e[i]);this.ajax.deleteEvent.send()}},clickEntry:function(t){var e=w.fireEvent("fabrik.viz.fullcalendar.clickentry",[this,t]).eventResults;if("null"===typeOf(e)||0===e.length||!e.contains(!1))if(""!==t.customURL)window.open(t.customURL,"_blank");else if(!1===this.options.showFullDetails){var i=p("#fabrikEvent_modal.modal");i.find(".modal-title").html(p("#"+t.id).attr("data-title")),i.find(".modal-body").html(p("#"+t.id).attr("data-content")),i.find(".modal-footer .calEventButtons").html(p("#"+t.id).attr("data-buttons")),i.modal("show")}else this.viewEntry(t)},openAddEvent:function(t,e,i){var n,a,o,d,s,l,r;if(!1!==this.options.canAdd&&("month"!==e||!0!==this.options.readonlyMonth)){switch(t.type){case"dblclick":case"touchend":r=i;break;case"click":r=moment();break;default:return void window.alert("Unknown event in OpenAddEvent: "+t.type)}"month"===e?a=o="00":(a=(a=r.hour())<10?"0"+a:a,o=(o=r.minute())<10?"0"+o:o),n=(n=r.date())<10?"0"+n:n,d=(d=r.month()+1)<10?"0"+d:d,s=r.year(),this.clickdate=s+"-"+d+"-"+n+" "+a+":"+o+":00",("dblclick"!==t.type&&"touchend"!==t.type||this.dateInLimits(this.clickdate))&&(1<this.options.eventLists.length?this.openChooseEventTypeForm(this.clickdate,void 0):((l={rowid:"",id:""}).listid=this.options.eventLists[0].value,l.title=Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_ADD_EVENT"),this.addEvForm(l)))}},dateInLimits:function(t){var e=new moment(t);if(w.fireEvent("fabrik.viz.fullcalendar.dateinlimits",[this,t]).eventResults.contains(!1))return!1;if(""!==this.options.dateLimits.min){var i=new moment(this.options.dateLimits.min);if(e.isBefore(i))return window.alert(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DATE_ADD_TOO_EARLY")),!1}if(""!==this.options.dateLimits.max){var n=new moment(this.options.dateLimits.max);if(e.isAfter(n))return window.alert(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DATE_ADD_TOO_LATE")),!1}return!0},openChooseEventTypeForm:function(t,e){var i=this.options.url.choose;i.test(/\?/)?i+="&":i+="?",i+="d="+t,i+="&rawd="+e,i+="&renderContext="+this.el.prop("id").replace(/visualization_/,""),i+="&task=chooseAddEvent",this.windowopts.contentURL=i,this.windowopts.id="chooseeventwin",this.windowopts.modalId="fullcalendar_!chooseeventwin",w.getWindow(this.windowopts)}})});