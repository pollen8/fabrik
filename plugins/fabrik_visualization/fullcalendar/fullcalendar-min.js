/*! Fabrik */
var fabrikFullcalendar=new Class({Implements:[Options],options:{url:{del:"index.php?option=com_fabrik&controller=visualization.fullcalendar&view=visualization&task=deleteEvent&format=raw"}},initialize:function(a,b){function c(a,b,c){i=a,j=c.name,jQuery("#calendar").on("mousemove",d)}function d(){i=j=null,jQuery("#calendar").off("mousemove",d)}this.el=document.id(a),this.setOptions(b),this.date=new Date,this.clickdate=null,this.ajax={},this.windowopts={id:"addeventwin",title:"",loadMethod:"xhr",minimizable:!1,evalScripts:!0,width:380,height:320,onContentLoaded:function(a){a.fitToContent()}.bind(this)},"null"!==typeOf(this.el.getElement(".addEventButton"))&&this.el.getElement(".addEventButton").addEvent("click",function(a){this.openAddEvent(a)}.bind(this)),Fabrik.addEvent("fabrik.form.submitted",function(){jQuery("#calendar").fullCalendar("refetchEvents"),Fabrik.Windows.addeventwin.close()}.bind(this));{var e=[];this.options.url}this.options.eventLists.each(function(a,b){e.push({events:new Function("start","end","tz","callback","new Request({'url': '"+this.options.url.add+"&listid="+a.value+"&eventListKey="+b+"','evalScripts': true,'onSuccess': function (e, json) {\nif (typeOf(json) !== 'null') {\nthis.processEvents(json, callback);\n}}.bind(this, callback)}).send();").bind(this),color:a.colour})}.bind(this));var f=this,g="";this.options.show_week!==!1&&(g+="agendaWeek"),this.options.show_day!==!1&&(g.length>0&&(g+=","),g+="agendaDay"),g.length>0&&(g="month,"+g);var h="month";switch(this.options.default_view){case"monthView":break;case"weekView":this.options.show_week!==!1&&(h="agendaWeek");break;case"dayView":this.options.show_day!==!1&&(h="agendaDay")}var i=null,j=null;jQuery("#calendar").dblclick(function(a){i&&f.openAddEvent(a,j,i)});var k={lang:this.options.lang,header:{left:"prev,next today",center:"title",right:g},fixedWeekCount:!1,timeFormat:this.options.time_format,defaultView:h,nextDayThreshold:"00:00:00",firstDay:this.options.first_week_day,eventSources:e,defaultTimedEventDuration:this.options.minDuration,minTime:this.options.open,maxTime:this.options.close,eventClick:function(a){return f.clickEntry(a),!1},dayClick:c,viewRender:function(a){"month"==a.name&&f.options.greyscaledweekend===!0&&(jQuery("td.fc-sat").css("background","#f2f2f2"),jQuery("td.fc-sun").css("background","#f2f2f2"))},eventRender:function(a,b){b.find(".fc-title").html(a.title)},loading:function(a){a||jQuery(".fc-view-container").delegate(".popover button.jclose","click",function(){var a=jQuery(this).data("popover");jQuery("#"+a).popover("hide")})},eventAfterAllRender:function(){}};jQuery.extend(!0,k,JSON.parse(f.options.calOptions)),jQuery("#calendar").fullCalendar(k),document.addEvent("click:relay(button[data-task=viewCalEvent], a[data-task=viewCalEvent])",function(a){a.preventDefault();var b=a.target.findClassUp("calEventButtons").id;b=b.replace(/_buttons/,"");var c=jQuery("#calendar").fullCalendar("clientEvents",b)[0];jQuery("#"+b).popover("hide"),this.viewEntry(c)}.bind(this)),document.addEvent("click:relay(button[data-task=editCalEvent], a[data-task=editCalEvent])",function(a){a.preventDefault();var b=a.target.findClassUp("calEventButtons").id;b=b.replace(/_buttons/,"");var c=jQuery("#calendar").fullCalendar("clientEvents",b)[0];jQuery("#"+b).popover("hide"),this.editEntry(c)}.bind(this)),document.addEvent("click:relay(button[data-task=deleteCalEvent], a[data-task=deleteCalEvent])",function(a){a.preventDefault();var b=a.target.findClassUp("calEventButtons").id;b=b.replace(/_buttons/,"");var c=jQuery("#calendar").fullCalendar("clientEvents",b)[0];jQuery("#"+b).popover("hide"),this.deleteEntry(c)}.bind(this)),jQuery(document).on("click",".popover .jclose",function(a){a.preventDefault();var b=jQuery(a.target).attr("data-popover");jQuery("#"+b).popover("hide")}.bind(this)),this.ajax.deleteEvent=new Request({url:this.options.url.del,data:{visualizationid:this.options.calendarId},onComplete:function(){jQuery("#calendar").fullCalendar("refetchEvents")}.bind(this)})},processEvents:function(a,b){a=$H(JSON.decode(a));var c=[];a.each(function(a){var b=jQuery(Fabrik.jLayouts["fabrik-visualization-fullcalendar-event-popup"])[0],d=a._listid+"_"+a.id;b.id="fabrikevent_"+d;var e=jQuery(Fabrik.jLayouts["fabrik-visualization-fullcalendar-viewevent"])[0],f=moment(a.startdate),g=moment(a.enddate),h=dispEndDate="";(moment(g.format("YYYY-MM-DD"))>moment(f.format("YYYY-MM-DD"))||a.startShowTime===!1&&a.endShowTime===!1)&&(h=f.format("MMM DD")+" ",dispEndDate=g.format("MMM DD")+" ");var i=dispEndTime="";a.startShowTime===!0&&a.endShowTime===!0&&(i=f.format("hh.mm A"),dispEndTime=g.format("hh.mm A")),e.getElement("#viewstart").innerHTML=h+i,e.getElement("#viewend").innerHTML=dispEndDate+dispEndTime;var j=jQuery(Fabrik.jLayouts["fabrik-visualization-fullcalendar-viewbuttons"])[0];jQuery(j)[0].id="fabrikevent_buttons_"+d;var k=j.getElement(".popupDelete");a._canDelete===!1?k.destroy():k.setProperty("title",Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DELETE"));var l=j.getElement(".popupEdit");a._canEdit===!1?l.destroy():l.setProperty("title",Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_EDIT"));var m=j.getElement(".popupView");a._canView===!1?m.destroy():m.setProperty("title",Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_VIEW")),jQuery(b).attr("data-content",jQuery(e).prop("outerHTML")+jQuery(j).prop("outerHTML"));var n=""==h?"auto":"200px";jQuery(b).attr("data-title",'<div style="width:'+n+'"><div style="float:left;"><button class="btn jclose" data-popover="'+b.id+'" data-toggle="tooltip" title="'+Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_CLOSE")+'"><i class="icon-delete"></i></button></div><div style="text-align:center;">'+a.label+"</div></div>"),jQuery(b).append(a.label),c.push({id:b.id,title:jQuery(b).prop("outerHTML"),start:a.startdate,end:a.enddate,url:a.link,className:a.status,allDay:a.allday,listid:a._listid,rowid:a.__pk_val,formid:a._formid})}.bind(c)),b(c)},addEvForm:function(a){"undefined"!=typeof jQuery&&jQuery(this.popOver).popover("hide"),this.windowopts.id="addeventwin";var b="index.php?option=com_fabrik&controller=visualization.fullcalendar&view=visualization&task=addEvForm&format=raw&listid="+a.listid+"&rowid="+a.rowid;if(b+="&visualizationid="+this.options.calendarId,a.nextView&&(b+="&nextview="+a.nextView),b+="&fabrik_window_id="+this.windowopts.id,null!==this.clickdate){var c=jQuery("#calendar").fullCalendar("option","defaultTimedEventDuration").split(":"),d=moment(this.clickdate).add({h:c[0],m:c[1],s:c[2]}).format("YYYY-MM-DD HH:mm:ss");b+="&start_date="+this.clickdate+"&end_date="+d}this.windowopts.type="window",this.windowopts.contentURL=b,this.windowopts.title=a.title;var e=this.options.filters;this.windowopts.onContentLoaded=function(a){e.each(function(a){if(document.id(a.key))switch(document.id(a.key).get("tag")){case"select":document.id(a.key).selectedIndex=a.val;break;case"input":document.id(a.key).value=a.val}}),a.fitToContent(!1)}.bind(this),Fabrik.getWindow(this.windowopts)},viewEntry:function(a){this.clickdate=null;var b={};b.id=a.formid,b.rowid=a.rowid,b.listid=a.listid,b.nextView="details",b.title=Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_VIEW_EVENT"),this.addEvForm(b)},editEntry:function(a){this.clickdate=null;var b={};b.id=a.formid,b.rowid=a.rowid,b.listid=a.listid,b.nextView="form",b.title=Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_EDIT_EVENT"),this.addEvForm(b)},deleteEntry:function(a){confirm(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_CONF_DELETE"))&&(this.ajax.deleteEvent.options.data={id:a.rowid,listid:a.listid},this.ajax.deleteEvent.send())},clickEntry:function(a){if(this.options.showFullDetails===!1){var b="fabrikevent_"+a.listid+"_"+a.rowid;jQuery("#"+b).popover("show")}else this.viewEntry(a)},openAddEvent:function(a,b,c){var d,e,f,g,h,i,j,k;if(this.options.canAdd!==!1&&("month"!=b||this.options.readonlyMonth!==!0)){switch(a.type){case"dblclick":k=c;break;case"click":a.stop(),k=moment();break;default:return void alert("Unknown event in OpenAddEvent: "+a.type)}"month"==b?f=g="00":(f=(f=k.hour())<10?"0"+f:f,g=(g=k.minute())<10?"0"+g:g),e=(e=k.date())<10?"0"+e:e,h=(h=k.month()+1)<10?"0"+h:h,i=k.year(),this.clickdate=i+"-"+h+"-"+e+" "+f+":"+g+":00",("dblclick"!=a.type||this.dateInLimits(this.clickdate))&&(this.options.eventLists.length>1?this.openChooseEventTypeForm(this.clickdate,d):(j={},j.rowid="",j.id="",j.listid=this.options.eventLists[0].value,j.title=Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_ADD_EVENT"),this.addEvForm(j)))}},dateInLimits:function(a){var b=new moment(a);if(""!==this.options.dateLimits.min){var c=new moment(this.options.dateLimits.min);if(b.isBefore(c))return alert(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DATE_ADD_TOO_EARLY")),!1}if(""!==this.options.dateLimits.max){var d=new moment(this.options.dateLimits.max);if(b.isAfter(d))return alert(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DATE_ADD_TOO_LATE")),!1}return!0},openChooseEventTypeForm:function(a,b){var c="index.php?option=com_fabrik&tmpl=component&view=visualization&controller=visualization.fullcalendar&task=chooseaddevent&id="+this.options.calendarId+"&d="+a+"&rawd="+b;c+="&renderContext="+this.el.id.replace(/visualization_/,""),this.windowopts.contentURL=c,this.windowopts.id="chooseeventwin",this.windowopts.onContentLoaded=function(){new Fx.Scroll(window).toElement("chooseeventwin")},Fabrik.getWindow(this.windowopts)}});