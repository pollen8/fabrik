/*! Fabrik */

define(["jquery","fab/element"],function(a,b){return window.FbTextarea=new Class({Extends:b,initialize:function(a,b){this.setPlugin("fabriktextarea"),this.parent(a,b),this.periodFn=function(){this.getTextContainer(),"undefined"!=typeof tinyMCE?!1!==this.container&&(clearInterval(c),this.watchTextContainer()):(clearInterval(c),this.watchTextContainer())};var c=this.periodFn.periodical(200,this);Fabrik.addEvent("fabrik.form.page.change.end",function(a){this.refreshEditor()}.bind(this)),Fabrik.addEvent("fabrik.form.submit.start",function(a){this.options.wysiwyg&&a.options.ajax&&"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave()}.bind(this))},unclonableProperties:function(){var a=this.parent();return a.push("container"),a},cloneUpdateIds:function(a){this.element=document.id(a),this.options.element=a,this.options.htmlId=a},watchTextContainer:function(){if("null"===typeOf(this.element)&&(this.element=document.id(this.options.element)),("null"!==typeOf(this.element)||(this.element=document.id(this.options.htmlId),"null"!==typeOf(this.element)))&&!0===this.options.editable){var a=this.getContainer();if(!1===a)return void fconsole("no fabrikElementContainer class found for textarea");var b=a.getElement(".fabrik_characters_left");if("null"!==typeOf(b))if(this.warningFX=new Fx.Morph(b,{duration:1e3,transition:Fx.Transitions.Quart.easeOut}),this.origCol=b.getStyle("color"),this.options.wysiwyg&&"undefined"!=typeof tinymce)if(tinymce.majorVersion>=4){var c=this._getTinyInstance();c.on("keyup",function(a){this.informKeyPress(a)}.bind(this)),c.on("focus",function(a){var b=this.element.getParent(".fabrikElementContainer");b.getElement("span.badge").addClass("badge-info"),b.getElement(".fabrik_characters_left").removeClass("muted")}.bind(this)),c.on("blur",function(a){var b=this.element.getParent(".fabrikElementContainer");b.getElement("span.badge").removeClass("badge-info"),b.getElement(".fabrik_characters_left").addClass("muted")}.bind(this)),c.on("blur",function(a){this.forwardEvent("blur")}.bind(this))}else tinymce.dom.Event.add(this.container,"keyup",function(a){this.informKeyPress(a)}.bind(this)),tinymce.dom.Event.add(this.container,"blur",function(a){this.forwardEvent("blur")}.bind(this));else"null"!==typeOf(this.container)&&(this.container.addEvent("keydown",function(a){this.informKeyPress(a)}.bind(this)),this.container.addEvent("blur",function(a){this.blurCharsLeft(a)}.bind(this)),this.container.addEvent("focus",function(a){this.focusCharsLeft(a)}.bind(this)))}},forwardEvent:function(a){var b=tinyMCE.activeEditor.getElement(),c=this.getContent();b.set("value",c),b.fireEvent("blur",new Event.Mock(b,a))},focusCharsLeft:function(){var a=this.element.getParent(".fabrikElementContainer");a.getElement("span.badge").addClass("badge-info"),a.getElement(".fabrik_characters_left").removeClass("muted")},blurCharsLeft:function(){var a=this.element.getParent(".fabrikElementContainer");a.getElement("span.badge").removeClass("badge-info"),a.getElement(".fabrik_characters_left").addClass("muted")},getCloneName:function(){return this.options.wysiwyg&&this.options.isGroupJoin?this.options.htmlId:this.options.element},cloned:function(a){if(this.options.wysiwyg){var b=this.element.getParent(".fabrikElement"),c=b.getElement("textarea").clone(!0,!0),d=b.getElement(".fabrik_characters_left");b.empty(),b.adopt(c),"null"!==typeOf(d)&&b.adopt(d.clone()),c.removeClass("mce_editable"),c.setStyle("display",""),this.element=c;var e=this.options.isGroupJoin?this.options.htmlId:this.options.element;this._addTinyEditor(e)}this.getTextContainer(),this.watchTextContainer(),this.parent(a)},decloned:function(a){if(this.options.wysiwyg){var b=this.options.isGroupJoin?this.options.htmlId:this.options.element;tinyMCE.execCommand("mceFocus",!1,b),this._removeTinyEditor(b)}},getTextContainer:function(){if(this.options.wysiwyg&&this.options.editable){var a=this.options.isGroupJoin?this.options.htmlId:this.options.element;document.id(a).addClass("fabrikinput");var b="undefined"!=typeof tinyMCE&&tinyMCE.get(a);b?this.container=b.getDoc():this.contaner=!1}else this.element=document.id(this.options.element),this.container=this.element;return this.container},getContent:function(){return this.options.wysiwyg?tinyMCE.activeEditor.getContent().replace(/<\/?[^>]+(>|$)/g,""):this.container.value},refreshEditor:function(){this.options.wysiwyg&&("undefined"!=typeof WFEditor?WFEditor.init(WFEditor.settings):"undefined"!=typeof tinymce&&tinyMCE.init(tinymce.settings),this.watchTextContainer())},_getTinyInstance:function(){return tinyMCE.majorVersion.toInt()>=4?tinyMCE.get(this.element.id):tinyMCE.getInstanceById(this.element.id)},_addTinyEditor:function(a){tinyMCE.majorVersion.toInt()>=4?tinyMCE.execCommand("mceAddEditor",!1,a):tinyMCE.execCommand("mceAddControl",!1,a)},_removeTinyEditor:function(a){tinyMCE.majorVersion.toInt()>=4?tinyMCE.execCommand("mceRemoveEditor",!1,a):tinyMCE.execCommand("mceRemoveControl",!1,a)},setContent:function(a){if(this.options.wysiwyg){var b=this._getTinyInstance(),c=b.setContent(a);return this.moveCursorToEnd(),c}return this.getTextContainer(),"null"!==typeOf(this.container)&&(this.container.value=a),null},moveCursorToEnd:function(){var a=this._getTinyInstance();a.selection.select(a.getBody(),!0),a.selection.collapse(!1)},informKeyPress:function(){var a=this.getContainer().getElement(".fabrik_characters_left"),b=(this.getContent(),this.itemsLeft());this.limitReached()?(this.limitContent(),this.warningFX.start({opacity:0,color:"#FF0000"}).chain(function(){this.start({opacity:1,color:"#FF0000"}).chain(function(){this.start({opacity:0,color:this.origCol}).chain(function(){this.start({opacity:1})})})})):a.setStyle("color",this.origCol),a.getElement("span").set("html",b)},itemsLeft:function(){var a=0,b=this.getContent();return a="word"===this.options.maxType?this.options.max-b.split(" ").length:this.options.max-(b.length+1),a<0&&(a=0),a},limitContent:function(){var a,b=this.getContent();"word"===this.options.maxType?(a=b.split(" ").splice(0,this.options.max),a=a.join(" "),a+=this.options.wysiwyg?"&nbsp;":" "):a=b.substring(0,this.options.max),this.setContent(a)},limitReached:function(){var a=this.getContent();if("word"===this.options.maxType){return a.split(" ").length>this.options.max}return this.options.max-(a.length+1)<0},reset:function(){this.update(this.options.defaultVal)},update:function(a){if(this.getElement(),this.getTextContainer(),!this.options.editable)return void this.element.set("html",a);this.setContent(a)}}),window.FbTextarea});