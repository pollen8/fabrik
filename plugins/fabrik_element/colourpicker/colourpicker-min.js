/*! Fabrik */

define(["jquery","fab/element"],function(o,t){new Class({initialize:function(t,i){this.field=document.id(t),this.slider=i,this.field.addEvent("change",function(t){this.update(t)}.bind(this))},destroy:function(){this.field.removeEvent("change",function(t){this.update(t)}.bind(this))},update:function(t){this.options.editable?this.slider.set(this.field.value.toInt()):this.element.set("html",t)}});window.ColourPicker=new Class({Extends:t,options:{red:0,green:0,blue:0,value:[0,0,0,1],showPicker:!0,swatchSizeWidth:"10px",swatchSizeHeight:"10px",swatchWidth:"160px"},initialize:function(t,i){this.setPlugin("colourpicker"),"null"!==typeOf(i.value)&&"undefined"!==i.value[0]||(i.value=[0,0,0,1]),this.parent(t,i),i.outputs=this.outputs,this.element=document.id(t),this.ini()},ini:function(){this.options.callback=function(t,i){t=this.update(t),i!==this.grad&&this.grad&&this.grad.update(t)}.bind(this),this.widget=this.element.getParent(".fabrikSubElementContainer").getElement(".colourpicker-widget"),this.setOutputs();new Drag.Move(this.widget,{handle:this.widget.getElement(".draggable")});this.options.showPicker&&this.createSliders(this.strElement),this.swatch=new i(this.options.element,this.options,this),this.widget.getElement("#"+this.options.element+"-swatch").empty().adopt(this.swatch),o(this.widget).hide(),this.options.showPicker&&(this.grad=new e(this.options.element,this.options,this),this.widget.getElement("#"+this.options.element+"-picker").empty().adopt(this.grad.square)),this.update(this.options.value);var t=this.widget.getElement(".modal-header a");t&&t.addEvent("click",function(t){t.stop(),o(this.widget).hide()}.bind(this))},cloned:function(s){this.parent(s);var t=this.element.getParent(".fabrikSubElementContainer").getElement(".colourpicker-widget"),i=t.getElements(".tab-pane"),e=t.getElements("a[data-toggle=tab]");e.each(function(t){var i=t.get("href").split("-"),e=i[0].split("_");e[e.length-1]=s,e=e.join("_"),e+="-"+i[1],t.href=e}),i.each(function(t){var i=t.get("id").split("-"),e=i[0].split("_");e[e.length-1]=s,e=e.join("_"),e+="-"+i[1],t.id=e}),e.each(function(i){i.addEvent("click",function(t){t.stop(),o(i).tab("show")})}),this.ini()},setOutputs:function(t){this.outputs={},this.outputs.backgrounds=this.getContainer().getElements(".colourpicker_bgoutput"),this.outputs.foregrounds=this.getContainer().getElements(".colourpicker_output"),this.outputs.backgrounds.each(function(t){t.removeEvents("click"),t.addEvent("click",function(t){this.toggleWidget(t)}.bind(this))}.bind(this)),this.outputs.foregrounds.each(function(t){t.removeEvents("click"),t.addEvent("click",function(t){this.toggleWidget(t)}.bind(this))}.bind(this))},createSliders:function(t){this.sliderRefs=[],this.table=new Element("table"),this.tbody=new Element("tbody"),this.createColourSlideHTML(t,"red","Red:",this.options.red),this.createColourSlideHTML(t,"green","Green:",this.options.green),this.createColourSlideHTML(t,"blue","Blue:",this.options.blue),this.table.appendChild(this.tbody),this.widget.getElement(".sliders").empty().appendChild(this.table),Fabrik.addEvent("fabrik.colourpicker.slider",function(t,i,e){this.sliderRefs.contains(t.element.id)&&(this.options.colour[i]=e,this.update(this.options.colour.red+","+this.options.colour.green+","+this.options.colour.blue))}.bind(this)),this.redField.addEvent("change",function(t){this.updateFromField(t,"red")}.bind(this)),this.greenField.addEvent("change",function(t){this.updateFromField(t,"green")}.bind(this)),this.blueField.addEvent("change",function(t){this.updateFromField(t,"blue")}.bind(this))},createColourSlideHTML:function(t,i,e,s){var o=new Element("input.input-mini input "+i+"SliderField",{type:"text",id:t+i+"redField",size:"3",value:s}),n=[new Element("td").set("text",e),new Element("td").adopt(o)],h=new Element("tr").adopt(n);this.tbody.appendChild(h),this[i+"Field"]=o},updateAll:function(t,i,e){t=t?t.toInt():0,i=i?i.toInt():0,e=e?e.toInt():0,this.options.showPicker&&(this.redField.value=t,this.greenField.value=i,this.blueField.value=e),this.options.colour.red=t,this.options.colour.green=i,this.options.colour.blue=e,this.updateOutputs()},updateOutputs:function(){var i=new Color([this.options.colour.red,this.options.colour.green,this.options.colour.blue,1]);this.outputs.backgrounds.each(function(t){t.setStyle("background-color",i)}),this.outputs.foregrounds.each(function(t){t.setStyle("background-color",i)}),i.red?this.element.value=i.red+","+i.green+","+i.blue:this.element.value=i.rgb.join(",")},update:function(t){if(!1!==this.options.editable)return"null"===typeOf(t)?t=[0,0,0]:"string"===typeOf(t)&&(t=t.split(",")),this.updateAll(t[0],t[1],t[2]),t;this.element.set("html",t)},updateFromField:function(t,i){var e=Math.min(255,t.target.value.toInt());t.target.value=e,isNaN(e)||(this.options.colour[i]=e,this.options.callback(this.options.colour.red+","+this.options.colour.green+","+this.options.colour.blue))},toggleWidget:function(t){t.stop(),this.widget.toggle()}});var i=new Class({Extends:Options,options:{},initialize:function(t,i){return this.element=document.id(t),this.setOptions(i),this.callback=this.options.callback,this.outputs=this.options.outputs,this.redField=null,this.widget=new Element("div"),this.colourNameOutput=new Element("span",{stlye:"padding:3px"}).inject(this.widget),this.createColourSwatch(t),this.widget},createColourSwatch:function(s){for(var o,t=new Element("div",{styles:{float:"left","margin-left":"5px",class:"swatchBackground"}}),n=0;n<this.options.swatch.length;n++){var h=new Element("div",{styles:{width:this.options.swatchWidth}}),i=this.options.swatch[n];o=0,$H(i).each(function(t,i){var e=s+"swatch-"+n+"-"+o;h.adopt(new Element("div",{id:e,styles:{float:"left",width:this.options.swatchSizeWidth,cursor:"crosshair",height:this.options.swatchSizeHeight,"background-color":"rgb("+i+")"},class:t,events:{click:function(t){this.updateFromSwatch(t)}.bind(this),mouseenter:function(t){this.showColourName(t)}.bind(this),mouseleave:function(t){this.clearColourName(t)}.bind(this)}})),o++}.bind(this)),t.adopt(h)}this.widget.adopt(t)},updateFromSwatch:function(t){t.stop();var i=new Color(t.target.getStyle("background-color"));this.options.colour.red=i[0],this.options.colour.green=i[1],this.options.colour.blue=i[2],this.showColourName(t),this.callback(i,this)},showColourName:function(t){this.colourName=t.target.className,this.colourNameOutput.set("text",this.colourName)},clearColourName:function(t){this.colourNameOutput.set("text","")}}),e=new Class({Extends:Options,options:{size:125},initialize:function(t,i){this.brightness=0,this.saturation=0,this.setOptions(i),this.callback=this.options.callback,this.container=document.id(t),"null"!==typeOf(this.container)&&(this.offset=0,this.margin=10,this.borderColour="rgba(155, 155, 155, 0.6)",this.hueWidth=40,this.colour=new Color(this.options.value),this.square=new Element("canvas",{width:this.options.size+65+"px",height:this.options.size+"px"}),this.square.inject(this.container),this.square.addEvent("click",function(t){this.doIt(t)}.bind(this)),this.down=!1,this.square.addEvent("mousedown",function(t){this.down=!0}.bind(this)),this.square.addEvent("mouseup",function(t){this.down=!1}.bind(this)),document.addEvent("mousemove",function(t){this.down&&this.doIt(t)}.bind(this)),this.drawCircle(),this.drawHue(),this.arrow=this.drawArrow(),this.positionCircle(this.options.size,0),this.update(this.options.value))},doIt:function(t){var i=this.options.size,e=this.options.size,s=this.square.getPosition(),o=t.page.x-s.x,n=t.page.y-s.y;o<i&&n<e?this.setColourFromSquareSelection(o,n):o>this.options.size+this.margin&&o<=this.options.size+this.hueWidth&&this.setHueFromSelection(o,n)},update:function(t){var i=new Color(t);this.brightness=i.hsb[2],this.saturation=i.hsb[1],this.colour=this.colour.setHue(i.hsb[0]),this.colour=this.colour.setSaturation(100),this.colour=this.colour.setBrightness(100),this.render(),this.positionCircleFromColour(i)},positionCircleFromColour:function(t){this.saturarion=t.hsb[1],this.brightness=t.hsb[2];var i=Math.floor(this.options.size*(this.saturarion/100)),e=Math.floor(this.options.size-this.options.size*(this.brightness/100));this.positionCircle(i,e)},drawCircle:function(){this.circle=new Element("canvas",{width:"10px",height:"10px"});var t=this.circle.getContext("2d");t.lineWidth=1,t.beginPath();var i=this.circle.width/2,e=this.circle.width/2;t.arc(i,e,4.5,0,2*Math.PI,!0),t.strokeStyle="#000",t.stroke(),t.beginPath(),t.arc(i,e,3.5,0,2*Math.PI,!0),t.strokeStyle="#FFF",t.stroke()},setHueFromSelection:function(t,i){i=Math.min(1,i/this.options.size);var e=360-360*(i=Math.max(0,i));this.colour=this.colour.setHue(e),this.render(),this.positionCircle();var s=this.colour;s=(s=s.setBrightness(this.brightness)).setSaturation(this.saturation),this.callback(s,this)},setColourFromSquareSelection:function(t,i){var e=this.square.getContext("2d");this.positionCircle(t,i);var s=e.getImageData(t,i,1,1).data,o=new Color([s[0],s[1],s[2]]);this.brightness=o.hsb[2],this.saturation=o.hsb[1],this.callback(o,this)},positionCircle:function(t,i){t=t||this.circleX,this.circleX=t,i=i||this.circleY,this.circleY=i,this.render();var e=this.square.getContext("2d"),s=this.offset-5;t=Math.max(-5,Math.round(t)+s),i=Math.max(-5,Math.round(i)+s),e.drawImage(this.circle,t,i)},drawHue:function(){var t=this.square.getContext("2d"),i=this.options.size+this.margin+this.offset,e=t.createLinearGradient(0,0,0,this.options.size+this.offset);e.addColorStop(0,"rgba(255, 0, 0, 1)"),e.addColorStop(5/6,"rgba(255, 255, 0, 1)"),e.addColorStop(4/6,"rgba(0, 255, 0, 1)"),e.addColorStop(.5,"rgba(0, 255, 255, 1)"),e.addColorStop(2/6,"rgba(0, 0, 255, 1)"),e.addColorStop(1/6,"rgba(255, 0, 255, 1)"),e.addColorStop(1,"rgba(255, 0, 0, 1)"),t.fillStyle=e,t.fillRect(i,this.offset,this.hueWidth-10,this.options.size),t.strokeStyle=this.borderColour,t.strokeRect(i+.5,this.offset+.5,this.hueWidth-11,this.options.size-1)},render:function(){var t=this.square.getContext("2d"),i=this.offset;t.clearRect(0,0,this.square.width,this.square.height);var e=this.options.size;t.fillStyle=this.colour.hex,t.fillRect(i,i,e,e);var s=t.createLinearGradient(i,i,e+i,0);s.addColorStop(0,"rgba(255, 255, 255, 1)"),s.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=s,t.fillRect(i,i,e,e),(s=t.createLinearGradient(0,i,0,e+i)).addColorStop(0,"rgba(0, 0, 0, 0)"),s.addColorStop(1,"rgba(0, 0, 0, 1)"),t.fillStyle=s,t.fillRect(i,i,e,e),t.strokeStyle=this.borderColour,t.strokeRect(i+.5,i+.5,e-1,e-1),this.drawHue();var o=(360-this.colour.hsb[0])/362*this.options.size-2,n=e+this.hueWidth+i+2,h=Math.max(0,Math.round(o)+i-1);t.drawImage(this.arrow,n,h)},drawArrow:function(){var t=new Element("canvas"),i=t.getContext("2d");t.width=16,t.height=16;for(var e=0;e<20;e++)i.beginPath(),i.fillStyle="#000",i.moveTo(0,4),i.lineTo(4,0),i.lineTo(4,8),i.fill();return i.translate(-16/3,-16),t}});return window.ColourPicker});