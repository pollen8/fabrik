/*! Fabrik */

define(["jquery","fab/list-plugin","fab/fabrik"],function(t,e,u){var h=function(e){var i=e.retrieve("uberC"),o=e.retrieve("mapid"),a=e.retrieve("fld").value,t=new google.maps.Geocoder;u.radiusSearchResults||(u.radiusSearchResults={}),u.radiusSearchResults[a]&&n(i,o,u.radiusSearchResults[a]),t.geocode({address:a},function(e,t){t===google.maps.GeocoderStatus.OK?(n(i,o,e[0].geometry.location),u.radiusSearchResults[a]=e[0].geometry.location):window.alert(Joomla.JText._("PLG_LIST_RADIUS_SEARCH_GEOCODE_ERROR").replace("%s",t))})},n=function(e,t,i){e.getElement("input[name^=radius_search_geocode_lat]").value=i.lat(),e.getElement("input[name^=radius_search_geocode_lon]").value=i.lng(),u.radiusSearch[t].map.setCenter(i),u.radiusSearch[t].marker.setPosition(i)};return window.geoCode=function(){u.googleMap=!0,window.addEvent("domready",function(){new google.maps.LatLng(u.radiusSearch.geocode_default_lat,u.radiusSearch.geocode_default_long);var c={zoom:4,mapTypeId:google.maps.MapTypeId.ROADMAP};u.radiusSearch="null"===typeOf(u.radiusSearch)?{}:u.radiusSearch,document.getElements(".radius_search_geocode_map").each(function(e){var t=e.getParent(".radius_search_geocode"),i=t.getElement("button"),o=i||t.getElement(".radius_search_geocode_field");if(1!==o.retrieve("events-added",0).toInt()){u.radiusSearch[e.id]="null"===typeOf(u.radiusSearch[e.id])?{}:u.radiusSearch[e.id],u.radiusSearch[e.id].map=new google.maps.Map(e,c);var a=t.getParent(".radius_search");o.store("events-added",1),o.store("uberC",a),o.store("mapid",e.id);var n,s=t.getElement(".radius_search_geocode_field");if(o.store("fld",s),"null"!==typeOf(i))i.addEvent("click",function(e){e.stop(),h(o)}),s.addEvent("keyup",function(e){"enter"===e.key&&h(o)});else s.addEvent("keyup",function(e){n&&clearTimeout(n),"enter"===e.key&&h(o),n=window.setTimeout(function(){h(o)},1e3)});var r=a.getElement("input[name=geo_code_def_zoom]").get("value").toInt(),l=a.getElement("input[name=geo_code_def_lat]").get("value").toFloat(),d=a.getElement("input[name=geo_code_def_lon]").get("value").toFloat();u.fireEvent("google.radiusmap.loaded",[e.id,r,l,d])}})})},new Class({Extends:e,options:{geocode_default_lat:"0",geocode_default_long:"0",geocode_default_zoom:4,prefilter:!0,prefilterDistance:1e3,prefilterDone:!1,offset_y:0,key:!1},geocoder:null,map:null,initialize:function(e){this.parent(e),u.radiusSearch=u.radiusSearch?u.radiusSearch:{};var t="radius_search_geocode_map"+this.options.renderOrder;if("null"===typeOf(u.radiusSearch[t])){if(u.radiusSearch[t]={},u.radiusSearch[t].geocode_default_lat=this.options.geocode_default_lat,u.radiusSearch[t].geocode_default_long=this.options.geocode_default_long,u.radiusSearch[t].geocode_default_zoom=this.options.geocode_default_zoom,u.addEvent("google.radiusmap.loaded",function(o,e,t,i){var a=new google.maps.LatLng(t,i);u.radiusSearch[o].loaded||(u.radiusSearch[o].loaded=!0,u.radiusSearch[o].map.setCenter(a),u.radiusSearch[o].map.setZoom(e),u.radiusSearch[o].marker=new google.maps.Marker({map:u.radiusSearch[o].map,draggable:!0,position:a}),google.maps.event.addListener(u.radiusSearch[o].marker,"dragend",function(){var e=u.radiusSearch[o].marker.getPosition(),t=document.id(o).getParent(".radius_search"),i=t.getElement("input[name^=radius_search_geocode_lat]");"null"!==typeOf(i)&&(i.value=e.lat(),t.getElement("input[name^=radius_search_geocode_lon]").value=e.lng())}),google.maps.event.addListener(u.radiusSearch[o].map,"drag",function(e){fconsole("dragged")}))}.bind(this)),u.loadGoogleMap(this.options.key,"geoCode"),"null"===typeOf(this.options.value)&&(this.options.value=0),"null"!==typeOf(this.listform)){if(this.listform=this.listform.getElement("#radius_search"+this.options.renderOrder),"null"===typeOf(this.listform))return void fconsole("didnt find element #radius_search"+this.options.renderOrder);this.listform.getElements("select[name^=radius_search_type]").addEvent("change",function(e){this.toggleFields(e)}.bind(this)),this.listform.getElements("input.cancel").addEvent("click",function(){this.win.close()}.bind(this)),this.active=!1,this.listform.getElement(".fabrik_filter_submit").addEvent("mousedown",function(e){this.active=!0,this.listform.getElement("input[name^=radius_search_active]").value=1}.bind(this))}if(this.options.value=this.options.value.toInt(),"null"===typeOf(this.listform))return;var i=this.listform.getElement(".radius_search_distance"),o=this.listform.getElement(".slider_output");this.mySlide=new Slider(this.listform.getElement(".fabrikslider-line"),this.listform.getElement(".knob"),{onChange:function(e){i.value=e,o.set("text",e+this.options.unit)}.bind(this),steps:this.options.steps}).set(0),this.mySlide.set(this.options.value),i.value=this.options.value,o.set("text",this.options.value),this.options.myloc&&!this.options.prefilterDone&&geo_position_js.init()&&geo_position_js.getCurrentPosition(function(e){this.setGeoCenter(e)}.bind(this),function(e){this.geoCenterErr(e)}.bind(this),{enableHighAccuracy:!0})}u.addEvent("listfilter.clear",function(e){e.contains(this.options.ref)&&this.clearFilter()}.bind(this)),this.makeWin(t)},makeWin:function(e){var o=document.id(e).getParent(".radius_search"),a=new Element("button.btn.button").set("html",'<i class="icon-location"></i> '+Joomla.JText._("PLG_LIST_RADIUS_SEARCH_BUTTON"));o.getParent().adopt(a);var t=0<this.options.offset_y?this.options.offset_y:null,i={id:"win_"+e,title:Joomla.JText._("PLG_LIST_RADIUS_SEARCH"),loadMethod:"html",content:o,width:500,height:540,offset_y:t,visible:!1,destroy:!1,onClose:function(e,t){var i;i=!this.active&&window.confirm(Joomla.JText._("PLG_LIST_RADIUS_SEARCH_CLEAR_CONFIRM"))?0:1,this.win.window.getElement("input[name^=radius_search_active]").value=i}.bind(this)},n=u.getWindow(i);a.addEvent("click",function(e){e.stop(),o.setStyles({position:"relative",left:0});var t=a.retrieve("win");t.center(),t.open(),t.fitToContent();var i="radius_search_geocode_map"+this.options.renderOrder;i in u.radiusSearch&&google.maps.event.trigger(u.radiusSearch[i].map,"resize")}.bind(this)),a.store("win",n),this.button=a,this.win=n,u.addEvent("list.filter",function(e){return this.injectIntoListForm()}.bind(this))},injectIntoListForm:function(){var e=this.button.retrieve("win").contentEl.clone();return e.hide(),t(this.button).parent().append(e),!0},setGeoCenter:function(e){this.geocenterpoint=e,this.geoCenter(e),this.prefilter()},prefilter:function(){this.options.prefilter&&(this.mySlide.set(this.options.prefilterDistance),this.listform.getElement("input[name^=radius_search_active]").value=1,this.listform.getElements("input[value=mylocation]").checked=!0,this.list?this.getList().submit("filter"):this.listform.getParent("form").submit())},geoCenter:function(e){"null"===typeOf(e)?window.alert(Joomla.JText._("PLG_VIEW_RADIUS_NO_GEOLOCATION_AVAILABLE")):(this.listform.getElement("input[name*=radius_search_lat]").value=e.coords.latitude.toFixed(2),this.listform.getElement("input[name*=radius_search_lon]").value=e.coords.longitude.toFixed(2))},geoCenterErr:function(e){fconsole("geo location error="+e.message)},toggleActive:function(e){},toggleFields:function(e){var t=e.target.getParent(".radius_search");switch(e.target.get("value")){case"latlon":t.getElement(".radius_search_place_container").hide(),t.getElement(".radius_search_coords_container").show(),t.getElement(".radius_search_geocode").setStyles({position:"absolute",left:"-100000px"});break;case"mylocation":t.getElement(".radius_search_place_container").hide(),t.getElement(".radius_search_coords_container").hide(),t.getElement(".radius_search_geocode").setStyles({position:"absolute",left:"-100000px"}),this.setGeoCenter(this.geocenterpoint);break;case"place":t.getElement(".radius_search_place_container").show(),t.getElement(".radius_search_coords_container").hide(),t.getElement(".radius_search_geocode").setStyles({position:"absolute",left:"-100000px"});break;case"geocode":t.getElement(".radius_search_place_container").hide(),t.getElement(".radius_search_coords_container").hide(),t.getElement(".radius_search_geocode").setStyles({position:"relative",left:0})}this.win.fitToContent(!1)},clearFilter:function(){return!(this.listform.getElement("input[name^=radius_search_active]").value=0)}})});