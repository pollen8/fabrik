var FbListInlineEdit=new Class({Extends:FbListPlugin,initialize:function(a){this.parent(a);this.defaults={};this.editors={};this.inedit=false;head.ready(function(){if(typeOf(this.getList().getForm())==="null"){return false}this.listid=this.options.listid;this.setUp()}.bind(this));Fabrik.addEvent("fabrik.list.clearrows",function(){this.cancel()}.bind(this));Fabrik.addEvent("fabrik.list.inlineedit.stopEditing",function(){this.stopEditing()}.bind(this));Fabrik.addEvent("fabrik.list.updaterows",function(){this.watchCells()}.bind(this));Fabrik.addEvent("fabrik.list.ini",function(){var b=Fabrik.blocks["list_"+this.options.ref];var c=b.form.toQueryString().toObject();c.format="raw";var d=new Request({url:"",data:c,onSuccess:function(e){e=Json.evaluate(e.stripScripts());b.options.data=e.data}.bind(this)}).send()}.bind(this));Fabrik.addEvent("fabrik.element.click",function(){if(Object.getLength(this.options.elements)===1&&this.options.showSave===false){this.save(null,this.editing)}}.bind(this))},setUp:function(){if(typeOf(this.getList().getForm())==="null"){return}this.scrollFx=new Fx.Scroll(window,{wait:false});this.watchCells();document.addEvent("keydown",this.checkKey.bindWithEvent(this))},watchCells:function(){var a=false;this.getList().getForm().getElements(".fabrik_element").each(function(c,b){if(this.canEdit(c)){if(!a&&this.options.loadFirst){a=this.edit(null,c);if(a){this.select(null,c)}}if(!this.isEditable(c)){return}this.setCursor(c);c.removeEvents();c.addEvent(this.options.editEvent,this.edit.bindWithEvent(this,[c]));c.addEvent("click",this.select.bindWithEvent(this,[c]));c.addEvent("mouseenter",function(d){if(!this.isEditable(c)){c.setStyle("cursor","pointer")}}.bind(this));c.addEvent("mouseleave",function(d){c.setStyle("cursor","")})}}.bind(this))},checkKey:function(d){var c,f,a;if(typeOf(this.td)!=="element"){return}switch(d.code){case 39:if(this.inedit){return}if(typeOf(this.td.getNext())==="element"){d.stop();this.select(d,this.td.getNext())}break;case 9:if(this.inedit){if(this.options.tabSave){if(typeOf(this.editing)==="element"){this.save(d,this.editing)}else{this.edit(d,this.td)}}var b=d.shift?this.getPreviousEditable(this.td):this.getNextEditable(this.td);if(typeOf(b)==="element"){d.stop();this.select(d,b);this.edit(d,this.td)}return}d.stop();if(d.shift){if(typeOf(this.td.getPrevious())==="element"){this.select(d,this.td.getPrevious())}}else{if(typeOf(this.td.getNext())==="element"){this.select(d,this.td.getNext())}}break;case 37:if(this.inedit){return}if(typeOf(this.td.getPrevious())==="element"){d.stop();this.select(d,this.td.getPrevious())}break;case 40:if(this.inedit){return}f=this.td.getParent();if(typeOf(f)==="null"){return}a=f.getElements("td").indexOf(this.td);if(typeOf(f.getNext())==="element"){d.stop();c=f.getNext().getElements("td");this.select(d,c[a])}break;case 38:if(this.inedit){return}f=this.td.getParent();if(typeOf(f)==="null"){return}a=f.getElements("td").indexOf(this.td);if(typeOf(f.getPrevious())==="element"){d.stop();c=f.getPrevious().getElements("td");this.select(d,c[a])}break;case 27:d.stop();this.select(d,this.editing);this.cancel(d);break;case 13:d.stop();if(typeOf(this.editing)==="element"){this.save(d,this.editing)}else{this.edit(d,this.td)}break}},select:function(f,h){if(!this.isEditable(h)){return}var b=this.getElementName(h);var c=this.options.elements[b];if(typeOf(c)===false){return}if(typeOf(this.td)==="element"){this.td.removeClass(this.options.focusClass)}this.td=h;if(typeOf(this.td)==="element"){this.td.addClass(this.options.focusClass)}if(typeOf(this.td)==="null"){return}if(f&&(f.type!=="click"&&f.type!=="mouseover")){var d=this.td.getPosition();var a=d.x-(window.getSize().x/2)-(this.td.getSize().x/2);var g=d.y-(window.getSize().y/2)+(this.td.getSize().y/2);this.scrollFx.start(a,g)}},getElementName:function(d){var b=d.className.split(" ").filter(function(e,c){return e!=="fabrik_element"&&e!=="fabrik_row"});var a=b[0].replace("fabrik_row___","");return a},setCursor:function(c){var a=this.getElementName(c);var b=this.options.elements[a];if(typeOf(b)==="null"){return}c.addEvent("mouseover",function(d){if(this.isEditable(d.target)){d.target.setStyle("cursor","pointer")}});c.addEvent("mouseleave",function(d){if(this.isEditable(d.target)){d.target.setStyle("cursor","")}})},isEditable:function(a){if(a.hasClass("fabrik_uneditable")||a.hasClass("fabrik_ordercell")||a.hasClass("fabrik_select")||a.hasClass("fabrik_actions")){return false}return true},getPreviousEditable:function(d){var c=false;var b=this.getList().getForm().getElements(".fabrik_element");for(var a=b.length;a>=0;a--){if(c){if(this.canEdit(b[a])){return b[a]}}if(b[a]===d){c=true}}return false},getNextEditable:function(c){var b=false;var a=this.getList().getForm().getElements(".fabrik_element").filter(function(e,d){if(b){if(this.canEdit(e)){b=false;return true}}if(e===c){b=true}return false}.bind(this));return a.getLast()},canEdit:function(c){if(!this.isEditable(c)){return false}var a=this.getElementName(c);var b=this.options.elements[a];if(typeOf(b)==="null"){return false}return true},edit:function(e,td){Fabrik.fireEvent("fabrik.plugin.inlineedit.editing");if(this.inedit){if(this.options.editEvent==="mouseover"){if(td===this.editing){return}this.select(e,this.editing);this.cancel()}else{return}}if(!this.canEdit(td)){return false}if(typeOf(e)!=="null"){e.stop()}var element=this.getElementName(td);var rowid=td.getParent(".fabrik_row").id.replace("list_"+this.list.id+"_row_","");var opts=this.options.elements[element];if(typeOf(opts)==="null"){return}this.inedit=true;this.editing=td;this.defaults[rowid+"."+opts.elid]=td.innerHTML;var data=this.getDataFromTable(td);if(typeOf(this.editors[opts.elid])==="null"||typeOf(Fabrik["inlineedit_"+opts.elid])==="null"){Fabrik.loader.start(td.getParent());var inline=this.options.showSave?1:0;new Request({evalScripts:function(script,text){this.javascript=script}.bind(this),evalResponse:false,url:"",data:{element:element,elid:opts.elid,elementid:Object.values(opts.plugins),rowid:rowid,formid:this.options.formid,listid:this.options.listid,inlinesave:inline,inlinecancel:this.options.showCancel,option:"com_fabrik",task:"form.inlineedit",format:"raw"},onComplete:function(r){Fabrik.loader.stop(td.getParent());(function(){$exec(this.javascript)}.bind(this)).delay(1000);td.empty().set("html",r);this._animate(td,"in");r=r+'<script type="text/javascript">'+this.javascript+"<\/script>";this.editors[opts.elid]=r;this.watchControls(td);this.setFocus(td)}.bind(this)}).send()}else{this.javascript;var html=this.editors[opts.elid].stripScripts(function(script){this.javascript=script}.bind(this));td.empty().set("html",html);eval(this.javascript);Fabrik.addEvent("fabrik.list.inlineedit.setData",function(){$H(opts.plugins).each(function(fieldid){console.log("update",fieldid,data[fieldid]);Fabrik["inlineedit_"+opts.elid].elements[fieldid].update(data[fieldid]);Fabrik["inlineedit_"+opts.elid].elements[fieldid].select()});this.watchControls(td);this.setFocus(td)}.bind(this))}return true},_animate:function(a,b){return},getDataFromTable:function(f){var c=Fabrik.blocks["list_"+this.options.ref].options.data;var b=this.getElementName(f);var e=f.getParent(".fabrik_row").id;var a={};this.vv=[];if(typeOf(c)==="object"){c=$H(c)}c.each(function(j){if(typeOf(j)==="array"){for(var g=0;g<j.length;g++){if(j[g].id===e){this.vv.push(j[g])}}}else{var h=j.filter(function(i){return i.id===e})}}.bind(this));var d=this.options.elements[b];if(this.vv.length>0){$H(d.plugins).each(function(h,g){a[h]=this.vv[0].data[g+"_raw"]}.bind(this))}return a},setTableData:function(d,b,c){ref=d.id;var a=Fabrik.blocks["list_"+this.options.ref].options.data;if(typeOf(a)==="object"){a=$H(a)}a.each(function(f,e){f.each(function(h,g){if(h.id===ref){h.data[b+"_raw"]=c}}.bind(this))}.bind(this))},setFocus:function(a){if(typeOf(a.getElement(".fabrikinput"))!=="null"){a.getElement(".fabrikinput").focus()}},watchControls:function(a){if(typeOf(a.getElement(".inline-save"))!=="null"){a.getElement(".inline-save").removeEvents("click").addEvent("click",this.save.bindWithEvent(this,[a]))}if(typeOf(a.getElement(".inline-cancel"))!=="null"){a.getElement(".inline-cancel").removeEvents("click").addEvent("click",this.cancel.bindWithEvent(this,[a]))}},save:function(f,i){if(!this.editing){return}this.inedit=false;if(f){f.stop()}var a=this.getElementName(i);var c=this.options.elements[a];Fabrik.loader.start(i.getParent());var h=this.editing.getParent(".fabrik_row");var b=h.id.replace("list_"+this.list.id+"_row_","");i.removeClass(this.options.focusClass);var g=Fabrik["inlineedit_"+c.elid];if(typeOf(g)==="null"){fconsole("issue saving from inline edit: eObj not defined");this.cancel(f);return false}var d={option:"com_fabrik",task:"form.process",format:"raw",_packageId:1,fabrik_ajax:1,element:a,elid:c.elid,plugin:c.plugin,rowid:b,listid:this.options.listid,formid:this.options.formid,fabrik_ignorevalidation:1};$H(g.elements).each(function(j){j.getElement();var e=j.getValue();this.setTableData(h,j.options.element,e);d[j.options.element]=e}.bind(this));d[g.token]=1;i.empty();new Request({url:"",data:d,evalScripts:true,onComplete:function(e){i.empty().set("html",e);Fabrik.loader.stop(i.getParent());Fabrik.fireEvent("fabrik.list.updaterows")}.bind(this)}).send();this.editing=null},stopEditing:function(a){var b=this.editing;if(b!==false){b.removeClass(this.options.focusClass)}console.log(b);this.editing=null;this.inedit=false},cancel:function(f){if(f){f.stop()}if(typeOf(this.editing)!=="element"){return}var g=this.editing.getParent(".fabrik_row");if(g===false){return}var d=g.id.replace("list_"+this.getList().id+"_row_","");var i=this.editing;if(i!==false){var a=this.getElementName(i);var b=this.options.elements[a];var h=this.defaults[d+"."+b.elid];i.set("html",h)}this.stopEditing()}});